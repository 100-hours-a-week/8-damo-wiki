name: Update Daily Scrum Discussion

on:
  schedule:
    # 매일 KST 09:10 (UTC 00:10)
    - cron: '10 0 * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  update-discussion:
    runs-on: ubuntu-latest
    permissions:
      discussions: write
    
    steps:
      - name: Get current date (KST)
        id: date
        run: |
          DATE=$(TZ=Asia/Seoul date +'%Y-%m-%d')
          echo "date=$DATE" >> $GITHUB_OUTPUT
      
      - name: Find Discussion and Collect Comments
        id: collect
        env:
          GH_TOKEN: ${{ secrets.DISCUSSION_TOKEN }}
        run: |
          TITLE="${{ steps.date.outputs.date }} - 데일리스크럼"
          
          echo "Looking for discussion with title: $TITLE"
          
          # Discussion 찾기
          DISCUSSION_DATA=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                discussions(first: 20, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes {
                    id
                    number
                    title
                    comments(first: 100) {
                      nodes {
                        author {
                          login
                        }
                        body
                      }
                    }
                  }
                }
              }
            }
          ' -F owner="100-hours-a-week" -F repo="8-team-name-wiki")
          
          # Discussion ID 추출
          DISCUSSION_ID=$(echo "$DISCUSSION_DATA" | jq -r --arg title "$TITLE" '
            .data.repository.discussions.nodes[] |
            select(.title == $title) |
            .id
          ')
          
          if [ -z "$DISCUSSION_ID" ] || [ "$DISCUSSION_ID" == "null" ]; then
            echo "no_discussion=true" >> $GITHUB_OUTPUT
            echo "Warning: Discussion not found for title: $TITLE"
            exit 0
          fi
          
          echo "discussion_id=$DISCUSSION_ID" >> $GITHUB_OUTPUT
          
          # 댓글 파싱해서 본문 생성
          NEW_BODY=$(echo "$DISCUSSION_DATA" | jq -r --arg title "$TITLE" '
            .data.repository.discussions.nodes[] |
            select(.title == $title) |
            "# " + $title + "\n\n" +
            (
              if (.comments.nodes | length) > 0 then
                [.comments.nodes[] | 
                  {
                    author: .author.login,
                    body: .body
                  }
                ] |
                group_by(.author) |
                map(
                  "## @" + .[0].author + "\n" +
                  (map(.body) | join("\n\n"))
                ) |
                join("\n\n")
              else
                "아직 작성된 댓글이 없습니다."
              end
            )
          ')
          
          echo "no_discussion=false" >> $GITHUB_OUTPUT
          
          # 멀티라인 출력
          {
            echo 'body<<EOF'
            echo "$NEW_BODY"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      
      - name: Update Discussion Body
        if: steps.collect.outputs.no_discussion == 'false'
        env:
          GH_TOKEN: ${{ secrets.DISCUSSION_TOKEN }}
        run: |
          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              updateDiscussion(input: {
                discussionId: $discussionId
                body: $body
              }) {
                discussion {
                  id
                  url
                }
              }
            }
          ' \
          -f discussionId="${{ steps.collect.outputs.discussion_id }}" \
          -f body="${{ steps.collect.outputs.body }}"
          
          echo "Successfully updated discussion body"
      
      - name: No Discussion Found
        if: steps.collect.outputs.no_discussion == 'true'
        run: |
          echo "::warning::No discussion found with title '${{ steps.date.outputs.date }} - 데일리스크럼'"